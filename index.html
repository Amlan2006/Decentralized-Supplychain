<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.1;
        }

        .bg-particle {
            position: absolute;
            background: linear-gradient(45deg, #4fc3f7, #29b6f6);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .header:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
        }

        .header h1 {
            font-size: 3em;
            font-weight: 700;
            background: linear-gradient(135deg, #4fc3f7, #29b6f6, #03a9f4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .wallet-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .wallet-section:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .connect-btn {
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(79, 195, 247, 0.3);
        }

        .connect-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(79, 195, 247, 0.4);
        }

        .connect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab.active {
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            color: white;
            box-shadow: 0 5px 20px rgba(79, 195, 247, 0.3);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4fc3f7;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4fc3f7;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.2);
        }

        .btn {
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(79, 195, 247, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #37474f, #455a64);
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 30px rgba(55, 71, 79, 0.3);
        }

        .product-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .product-card:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(10px);
            border-color: #4fc3f7;
        }

        .product-id {
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 15px;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .status-approved {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 1px solid #4caf50;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid #ffc107;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid #4fc3f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            color: #4caf50;
        }

        .alert-error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #f44336;
            color: #f44336;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #4fc3f7, #29b6f6);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            margin-left: 30px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -45px;
            top: 25px;
            width: 12px;
            height: 12px;
            background: #4fc3f7;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .tabs {
                overflow-x: scroll;
            }
            
            .tab {
                min-width: 120px;
            }
            
            .wallet-section {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="animated-bg" id="animatedBg"></div>
    
    <div class="container">
        <header class="header">
            <h1>Supply Chain Management</h1>
            <p>Blockchain-powered transparency and traceability</p>
        </header>

        <div class="wallet-section">
            <div id="walletInfo">
                <span id="accountAddress">Not Connected</span>
            </div>
            <button id="connectWallet" class="connect-btn">Connect Wallet</button>
        </div>

        <div id="alertContainer"></div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('products')">Products</button>
            <button class="tab" onclick="switchTab('create')">Create Product</button>
            <button class="tab" onclick="switchTab('quality')">Quality Control</button>
            <button class="tab" onclick="switchTab('logistics')">Logistics</button>
            <button class="tab" onclick="switchTab('admin')">Admin</button>
        </div>

        <!-- Products Tab -->
        <div id="products" class="tab-content active">
            <div class="card">
                <h2>Product Search & Tracking</h2>
                <div class="form-group">
                    <input type="number" id="searchProductId" placeholder="Enter Product ID">
                    <button class="btn" onclick="searchProduct()">Search Product</button>
                    <button class="btn btn-secondary" onclick="loadAllProducts()">Load All Products</button>
                </div>
            </div>
            <div id="productsContainer"></div>
        </div>

        <!-- Create Product Tab -->
        <div id="create" class="tab-content">
            <div class="card">
                <h2>Create New Product</h2>
                <form id="createProductForm">
                    <div class="grid">
                        <div class="form-group">
                            <label>Product Name</label>
                            <input type="text" id="productName" required>
                        </div>
                        <div class="form-group">
                            <label>Batch ID</label>
                            <input type="text" id="batchId" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="category" required>
                                <option value="">Select Category</option>
                                <option value="Food">Food</option>
                                <option value="Pharmaceutical">Pharmaceutical</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Textiles">Textiles</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Production Date</label>
                            <input type="date" id="productionDate" required>
                        </div>
                        <div class="form-group">
                            <label>Metadata URI</label>
                            <input type="url" id="metadataURI" placeholder="https://...">
                        </div>
                    </div>
                    <button type="submit" class="btn">Create Product</button>
                </form>
            </div>
        </div>

        <!-- Quality Control Tab -->
        <div id="quality" class="tab-content">
            <div class="card">
                <h2>Quality Control</h2>
                <div class="grid">
                    <div>
                        <h3>Assign Quality Inspector</h3>
                        <div class="form-group">
                            <label>Product ID</label>
                            <input type="number" id="assignProductId">
                        </div>
                        <div class="form-group">
                            <label>Inspector Address</label>
                            <input type="text" id="inspectorAddress" placeholder="0x...">
                        </div>
                        <button class="btn" onclick="assignQualityInspector()">Assign Inspector</button>
                    </div>
                    <div>
                        <h3>Add Certification</h3>
                        <div class="form-group">
                            <label>Product ID</label>
                            <input type="number" id="certProductId">
                        </div>
                        <div class="form-group">
                            <label>Certification</label>
                            <input type="text" id="certification" placeholder="ISO 9001, FDA Approved, etc.">
                        </div>
                        <button class="btn" onclick="addCertification()">Add Certification</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Approve Quality</h3>
                    <div class="grid">
                        <div class="form-group">
                            <label>Product ID</label>
                            <input type="number" id="approveProductId">
                        </div>
                        <div class="form-group">
                            <label>Expiry Date</label>
                            <input type="date" id="expiryDate">
                        </div>
                    </div>
                    <button class="btn" onclick="approveQuality()">Approve Quality</button>
                </div>
            </div>
        </div>

        <!-- Logistics Tab -->
        <div id="logistics" class="tab-content">
            <div class="card">
                <h2>Supply Chain Management</h2>
                <div class="grid">
                    <div>
                        <h3>Assign Distributor</h3>
                        <div class="form-group">
                            <label>Product ID</label>
                            <input type="number" id="distProductId">
                        </div>
                        <div class="form-group">
                            <label>Distributor Address</label>
                            <input type="text" id="distributorAddress" placeholder="0x...">
                        </div>
                        <button class="btn" onclick="assignDistributor()">Assign Distributor</button>
                    </div>
                    <div>
                        <h3>Assign Retailer</h3>
                        <div class="form-group">
                            <label>Product ID</label>
                            <input type="number" id="retailProductId">
                        </div>
                        <div class="form-group">
                            <label>Retailer Address</label>
                            <input type="text" id="retailerAddress" placeholder="0x...">
                        </div>
                        <button class="btn" onclick="assignRetailer()">Assign Retailer</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Sell to Consumer</h3>
                    <div class="grid">
                        <div class="form-group">
                            <label>Product ID</label>
                            <input type="number" id="sellProductId">
                        </div>
                        <div class="form-group">
                            <label>Consumer Address</label>
                            <input type="text" id="consumerAddress" placeholder="0x...">
                        </div>
                    </div>
                    <button class="btn" onclick="sellToConsumer()">Sell to Consumer</button>
                </div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="admin" class="tab-content">
            <div class="card">
                <h2>Role Management</h2>
                <div class="grid">
                    <div>
                        <h3>Register Producer</h3>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="producerAddr" placeholder="0x...">
                        </div>
                        <div class="form-group">
                            <label>Details</label>
                            <input type="text" id="producerDetails" placeholder="Company name, location...">
                        </div>
                        <button class="btn" onclick="registerProducer()">Register Producer</button>
                    </div>
                    <div>
                        <h3>Register Quality Inspector</h3>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="inspectorAddr" placeholder="0x...">
                        </div>
                        <div class="form-group">
                            <label>Details</label>
                            <input type="text" id="inspectorDetails" placeholder="Certification body...">
                        </div>
                        <button class="btn" onclick="registerQualityInspector()">Register Inspector</button>
                    </div>
                    <div>
                        <h3>Register Distributor</h3>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="distributorAddr" placeholder="0x...">
                        </div>
                        <div class="form-group">
                            <label>Details</label>
                            <input type="text" id="distributorDetails" placeholder="Company name, location...">
                        </div>
                        <button class="btn" onclick="registerDistributor()">Register Distributor</button>
                    </div>
                    <div>
                        <h3>Register Retailer</h3>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="retailerAddr" placeholder="0x...">
                        </div>
                        <div class="form-group">
                            <label>Details</label>
                            <input type="text" id="retailerDetails" placeholder="Store name, location...">
                        </div>
                        <button class="btn" onclick="registerRetailer()">Register Retailer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = '0x8464135c8F25Da09e49BC8782676a84730C318bC'; // Replace with your contract address
        const CONTRACT_ABI = [
            // Add your contract ABI here
            "function createProduct(string calldata _name, string calldata _batchId, string calldata _category, uint256 _productionDate, string calldata _metadataURI) external returns (uint256)",
            "function getBasicProductInfo(uint256 productId) external view returns (uint256 id, string memory name, string memory batchId, string memory category, address producer, address currentOwner, bool qualityApproved)",
            "function assignQualityInspector(uint256 productId, address inspector) external",
            "function addCertification(uint256 productId, string calldata certification) external",
            "function approveQuality(uint256 productId, uint256 expiryDate) external",
            "function assignDistributor(uint256 productId, address distributor) external",
            "function assignRetailer(uint256 productId, address retailer) external",
            "function sellToConsumer(uint256 productId, address buyer) external",
            "function registerProducer(address _producer, string calldata _details) external",
            "function registerQualityInspector(address _inspector, string calldata _details) external",
            "function registerDistributor(address _distributor, string calldata _details) external",
            "function registerRetailer(address _retailer, string calldata _details) external",
            "function getOwnershipHistory(uint256 productId) external view returns (address[] memory, uint256[] memory)",
            "function nextProductId() external view returns (uint256)"
        ];

        let provider;
        let signer;
        let contract;
        let userAccount;

        // Initialize animated background
        function initAnimatedBackground() {
            const bg = document.getElementById('animatedBg');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'bg-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.width = particle.style.height = Math.random() * 6 + 2 + 'px';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
                bg.appendChild(particle);
            }
        }

        // Connect wallet
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    userAccount = await signer.getAddress();
                    
                    if (CONTRACT_ADDRESS !== '0x...') {
                        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    }
                    
                    document.getElementById('accountAddress').textContent = 
                        userAccount.slice(0, 6) + '...' + userAccount.slice(-4);
                    document.getElementById('connectWallet').textContent = 'Connected';
                    document.getElementById('connectWallet').disabled = true;
                    
                    showAlert('Wallet connected successfully!', 'success');
                } catch (error) {
                    showAlert('Failed to connect wallet: ' + error.message, 'error');
                }
            } else {
                showAlert('Please install MetaMask!', 'error');
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Alert system
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Show loading state
        function showLoading(button) {
            button.innerHTML += '<span class="loading"></span>';
            button.disabled = true;
        }

        function hideLoading(button, text) {
            button.innerHTML = text;
            button.disabled = false;
        }

        // Create product
        async function createProduct() {
            if (!contract) {
                showAlert('Please connect your wallet first!', 'error');
                return;
            }

            const form = document.getElementById('createProductForm');
            const formData = new FormData(form);
            
            const name = document.getElementById('productName').value;
            const batchId = document.getElementById('batchId').value;
            const category = document.getElementById('category').value;
            const productionDate = new Date(document.getElementById('productionDate').value).getTime() / 1000;
            const metadataURI = document.getElementById('metadataURI').value || '';

            const button = form.querySelector('button[type="submit"]');
            showLoading(button);

            try {
                const tx = await contract.createProduct(name, batchId, category, productionDate, metadataURI);
                await tx.wait();
                showAlert('Product created successfully!', 'success');
                form.reset();
            } catch (error) {
                showAlert('Error creating product: ' + error.message, 'error');
            } finally {
                hideLoading(button, 'Create Product');
            }
        }

        // Search product
        async function searchProduct() {
            if (!contract) {
                showAlert('Please connect your wallet first!', 'error');
                return;
            }

            const productId = document.getElementById('searchProductId').value;
            if (!productId) return;

            try {
                const productInfo = await contract.getBasicProductInfo(productId);
                const ownershipHistory = await contract.getOwnershipHistory(productId);
                
                displayProduct({
                    id: productInfo[0],
                    name: productInfo[1],
                    batchId: productInfo[2],
                    category: productInfo[3],
                    producer: productInfo[4],
                    currentOwner: productInfo[5],
                    qualityApproved: productInfo[6],
                    ownersHistory: ownershipHistory[0],
                    transferTimestamps: ownershipHistory[1]
                });
            } catch (error) {
                showAlert('Product not found or error: ' + error.message, 'error');
            }
        }

        // Display product
        function displayProduct(product) {
            const container = document.getElementById('productsContainer');
            container.innerHTML = `
                <div class="product-card">
                    <div class="product-id">ID: ${product.id}</div>
                    <h3>${product.name}</h3>
                    <div class="grid">
                        <div>
                            <p><strong>Batch ID:</strong> ${product.batchId}</p>
                            <p><strong>Category:</strong> ${product.category}</p>
                            <p><strong>Producer:</strong> ${product.producer}</p>
                            <p><strong>Current Owner:</strong> ${product.currentOwner}</p>
                        </div>
                        <div>
                            <p><strong>Quality Status:</strong> 
                                <span class="status-badge ${product.qualityApproved ? 'status-approved' : 'status-pending'}">
                                    ${product.qualityApproved ? 'Approved' : 'Pending'}
                                </span>
                            </p>
                        </div>
                    </div>
                    ${product.ownersHistory ? `
                    <div class="card">
                        <h4>Ownership Timeline</h4>
                        <div class="timeline">
                            ${product.ownersHistory.map((owner, index) => `
                                <div class="timeline-item">
                                    <strong>Owner ${index + 1}:</strong> ${owner}<br>
                                    <small>Timestamp: ${product.transferTimestamps ? new Date(Number(product.transferTimestamps[index]) * 1000).toLocaleString() : 'N/A'}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Load all products
        async function loadAllProducts() {
            if (!contract) {
                showAlert('Please connect your wallet first!', 'error');
                return;
            }

            try {
                const nextId = await contract.nextProductId();
                const container = document.getElementById('productsContainer');
                container.innerHTML = '<div class="card"><p>Loading products...</p></div>';
                
                let productsHTML = '';
                for (let i = 1; i < nextId; i++) {
                    try {
                        const productInfo = await contract.getBasicProductInfo(i);
                        productsHTML += `
                            <div class="product-card">
                                <div class="product-id">ID: ${i}</div>
                                <h3>${productInfo[1]}</h3>
                                <div class="grid">
                                    <div>
                                        <p><strong>Batch ID:</strong> ${productInfo[2]}</p>
                                        <p><strong>Category:</strong> ${productInfo[3]}</p>
                                        <p><strong>Current Owner:</strong> ${productInfo[5]}</p>
                                    </div>
                                    <div>
                                        <p><strong>Quality Status:</strong> 
                                            <span class="status-badge ${productInfo[6] ? 'status-approved' : 'status-pending'}">
                                                ${productInfo[6] ? 'Approved' : 'Pending'}
                                            </span>
                                        </p>
                                        <button class="btn btn-secondary" onclick="searchSpecificProduct(${i})">View Details</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        console.log(`Product ${i} not found or error:`, error.message);
                    }
                }
                
                container.innerHTML = productsHTML || '<div class="card"><p>No products found.</p></div>';
            } catch (error) {
                showAlert('Error loading products: ' + error.message, 'error');
            }
        }

        // Search specific product for detailed view
        async function searchSpecificProduct(productId) {
            document.getElementById('searchProductId').value = productId;
            await searchProduct();
        }

        // Quality control functions
        async function assignQualityInspector() {
            if (!contract) {
                showAlert('Please connect your wallet first!', 'error');
                return;
            }

            const productId = document.getElementById('assignProductId').value;
            const inspectorAddress = document.getElementById('inspectorAddress').value;

            if (!productId || !inspectorAddress) {
                showAlert('Please fill in all fields!', 'error');
                return;
            }

            try {
                const tx = await contract.assignQualityInspector(productId, inspectorAddress);
                await tx.wait();
                showAlert('Quality inspector assigned successfully!', 'success');
                document.getElementById('assignProductId').value = '';
                document.getElementById('inspectorAddress').value = '';
            } catch (error) {
                showAlert('Error assigning inspector: ' + error.message, 'error');
            }
        }

        async function addCertification() {
            if (!contract) {
                showAlert('Please connect your wallet first!', 'error');
                return;
            }

            const productId = document.getElementById('certProductId').value;
            const certification = document.getElementById('certification').value;

            if (!productId || !certification) {
                showAlert('Please fill in all fields!', 'error');
                return;
            }

            try {
                const tx = await contract.addCertification(productId, certification);
                await tx.wait();
                showAlert('Certification added successfully!', 'success');
                document.getElementById('certProductId').value = '';
                document.getElementById('certification').value = '';
            } catch (error) {
                showAlert('Error adding certification: ' + error.message, 'error');
            }
        }

        async function approveQuality() {
            if (!contract) {
                showAlert('Please connect your wallet first!', 'error');
                return;
            }

            const productId = document.getElementById('approveProductId').value;
            const expiryDate = new Date(document.getElementById('expiryDate').value).getTime() / 1000;

            if (!productId || !expiryDate) {
                showAlert('Please fill in all fields!', 'error');
                return;
            }

            try {
                const tx = await contract.approveQuality(productId, expiryDate);
                await tx.wait();
                showAlert('Quality approved successfully!', 'success');
                document.getElementById('approveProductId').value = '';
                document.getElementById('expiryDate').value = '';
            } catch (error) {
                showAlert('Error approving quality: ' + error.message, 'error');
            }
        }

        // Logistics functions
        async function assignDistributor() {
            if (!contract) {
                showAlert('Please connect your wallet first!', 'error');
                return;
            }

            const productId = document.getElementById('distProductId').value;
            const distributorAddress = document.getElementById('distributorAddress').value;

            if (!productId || !distributorAddress) {
                showAlert('Please fill in all fields!', 'error');
                return;
            }

            try {
                const tx = await contract.assignDistributor(productId, distributorAddress);
                await tx.wait();
                showAlert('Distributor assigned successfully!', 'success');
                document.getElementById('distProductId').value = '';
                document.getElementById('distributorAddress').value = '';
            } catch (error) {
                showAlert('Error assigning distributor: ' + error.message, 'error');
            }
        }

        async function assignRetailer() {
            if (!contract) {
                showAlert('Please connect your wallet first!', 'error');
                return;
            }

            const productId = document.getElementById('retailProductId').value;
            const retailerAddress = document.getElementById('retailerAddress').value;

            if (!productId || !retailerAddress) {
                showAlert('Please fill in all fields!', 'error');
                return;
            }

            try {
                const tx = await contract.assignRetailer(productId, retailerAddress);
                await tx.wait();
                showAlert('Retailer assigned successfully!', 'success');
                document.getElementById('retailProductId').value = '';
                document.getElementById('retailerAddress').value = '';
            } catch (error) {
                showAlert('Error assigning retailer: ' + error.message, 'error');
            }
        }

        async function sellToConsumer() {
            if (!contract) {
                showAlert('Please connect your wallet first!', 'error');
                return;
            }

            const productId = document.getElementById('sellProductId').value;
            const consumerAddress = document.getElementById('consumerAddress').value;

            if (!productId || !consumerAddress) {
                showAlert('Please fill in all fields!', 'error');
                return;
            }

            try {
                const tx = await contract.sellToConsumer(productId, consumerAddress);
                await tx.wait();
                showAlert('Product sold to consumer successfully!', 'success');
                document.getElementById('sellProductId').value = '';
                document.getElementById('consumerAddress').value = '';
            } catch (error) {
                showAlert('Error selling to consumer: ' + error.message, 'error');
            }
        }

        // Admin functions
        async function registerProducer() {
            if (!contract) {
                showAlert('Please connect your wallet first!', 'error');
                return;
            }

            const address = document.getElementById('producerAddr').value;
            const details = document.getElementById('producerDetails').value;

            if (!address || !details) {
                showAlert('Please fill in all fields!', 'error');
                return;
            }

            try {
                const tx = await contract.registerProducer(address, details);
                await tx.wait();
                showAlert('Producer registered successfully!', 'success');
                document.getElementById('producerAddr').value = '';
                document.getElementById('producerDetails').value = '';
            } catch (error) {
                showAlert('Error registering producer: ' + error.message, 'error');
            }
        }

        async function registerQualityInspector() {
            if (!contract) {
                showAlert('Please connect your wallet first!', 'error');
                return;
            }

            const address = document.getElementById('inspectorAddr').value;
            const details = document.getElementById('inspectorDetails').value;

            if (!address || !details) {
                showAlert('Please fill in all fields!', 'error');
                return;
            }

            try {
                const tx = await contract.registerQualityInspector(address, details);
                await tx.wait();
                showAlert('Quality inspector registered successfully!', 'success');
                document.getElementById('inspectorAddr').value = '';
                document.getElementById('inspectorDetails').value = '';
            } catch (error) {
                showAlert('Error registering inspector: ' + error.message, 'error');
            }
        }

        async function registerDistributor() {
            if (!contract) {
                showAlert('Please connect your wallet first!', 'error');
                return;
            }

            const address = document.getElementById('distributorAddr').value;
            const details = document.getElementById('distributorDetails').value;

            if (!address || !details) {
                showAlert('Please fill in all fields!', 'error');
                return;
            }

            try {
                const tx = await contract.registerDistributor(address, details);
                await tx.wait();
                showAlert('Distributor registered successfully!', 'success');
                document.getElementById('distributorAddr').value = '';
                document.getElementById('distributorDetails').value = '';
            } catch (error) {
                showAlert('Error registering distributor: ' + error.message, 'error');
            }
        }

        async function registerRetailer() {
            if (!contract) {
                showAlert('Please connect your wallet first!', 'error');
                return;
            }

            const address = document.getElementById('retailerAddr').value;
            const details = document.getElementById('retailerDetails').value;

            if (!address || !details) {
                showAlert('Please fill in all fields!', 'error');
                return;
            }

            try {
                const tx = await contract.registerRetailer(address, details);
                await tx.wait();
                showAlert('Retailer registered successfully!', 'success');
                document.getElementById('retailerAddr').value = '';
                document.getElementById('retailerDetails').value = '';
            } catch (error) {
                showAlert('Error registering retailer: ' + error.message, 'error');
            }
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('createProductForm').addEventListener('submit', function(e) {
            e.preventDefault();
            createProduct();
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initAnimatedBackground();
            
            // Check if already connected
            if (window.ethereum && window.ethereum.selectedAddress) {
                connectWallet();
            }
        });

        // Handle account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function(accounts) {
                if (accounts.length === 0) {
                    document.getElementById('accountAddress').textContent = 'Not Connected';
                    document.getElementById('connectWallet').textContent = 'Connect Wallet';
                    document.getElementById('connectWallet').disabled = false;
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', function(chainId) {
                window.location.reload();
            });
        }
    </script>
</body>
</html>